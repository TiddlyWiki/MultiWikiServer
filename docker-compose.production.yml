# Docker Compose example for production deployment with custom configuration
version: '3.8'

services:
  mws:
    image: mws:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: multiwikiserver
    ports:
      # Map custom port if needed
      - "${MWS_PORT:-8080}:8080"
    volumes:
      # Use bind mounts for easier backup access
      - ./data/store:/data/store
      - ./data/passwords.key:/data/passwords.key
      - ./data/cache:/data/cache
    environment:
      - DATABASE_URL=file:./store/mws.db
      - NODE_ENV=production
      # Optional: Set custom timezone
      - TZ=${TZ:-UTC}
    restart: unless-stopped
    command: >
      sh -c "
      if [ ! -f /data/store/mws.db ]; then
        echo 'Initializing MultiWikiServer store...' &&
        npx mws init-store
      fi &&
      echo 'Starting MultiWikiServer...' &&
      npx mws listen --listener host=0.0.0.0 port=8080
      "
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

# For production, you might want to add a reverse proxy like Nginx or Traefik
# Example with Nginx (uncomment to use):
#  nginx:
#    image: nginx:alpine
#    container_name: mws-nginx
#    ports:
#      - "80:80"
#      - "443:443"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - ./ssl:/etc/nginx/ssl:ro
#    depends_on:
#      - mws
#    restart: unless-stopped
