datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  // prisma 7 will remove the need for native node files, everything will be js and wasm
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins", "driverAdapters"]
  binaryTargets   = []
}

enum Permission {
  READ
  WRITE
  ADMIN
}

model Recipes {
  recipe_id   String        @id @default(uuid(7))
  recipe_name String        @unique
  description String
  owner_id    String?
  recipe_bags Recipe_bags[]
  acl         RecipeAcl[]

  @@map("recipes")
}

model RecipeAcl {
  acl_id     Int        @id @default(autoincrement())
  role_id    String
  permission Permission
  recipe     Recipes    @relation(fields: [recipe_id], references: [recipe_id], onDelete: Cascade)
  recipe_id  String

  @@map("recipe_acl")
}

model Recipe_bags {
  recipe_id String
  bag_id    String
  position  Int
  with_acl  Boolean
  bag       Bags    @relation(fields: [bag_id], references: [bag_id], onDelete: Cascade)
  recipe    Recipes @relation(fields: [recipe_id], references: [recipe_id], onDelete: Cascade)

  @@unique([recipe_id, bag_id])
  @@index([recipe_id])
  @@map("recipe_bags")
}

model Bags {
  bag_id      String        @id @default(uuid(7))
  bag_name    String        @unique
  description String
  is_plugin   Boolean
  owner_id    String?
  recipe_bags Recipe_bags[]
  tiddlers    Tiddlers[]
  acl         BagAcl[]

  @@map("bags")
}

model BagAcl {
  acl_id     Int        @id @default(autoincrement())
  bag_id     String
  bag        Bags       @relation(fields: [bag_id], references: [bag_id], onDelete: Cascade)
  role_id    String
  permission Permission

  @@map("bag_acl")
}

model Tiddlers {
  // A tiddler ID is not actually required for the server currently.
  // If we add one in the future it would have a different purpose than this field does
  // this field is the revision id: despite originally being named tiddler_id, 
  // it changed for each revision. So renaming it made the most sense. 
  revision_id     String   @id @default(uuid(7))
  bag_id          String
  title           String
  is_deleted      Boolean
  attachment_hash String?
  fields          Fields[]
  // Deleting a referenced record (bag) will trigger the deletion of referencing record (tiddler).
  bag             Bags     @relation(fields: [bag_id], references: [bag_id], onDelete: Cascade)

  @@unique([bag_id, title])
  @@index([bag_id])
  @@map("tiddlers")
}

model Fields {
  revision_id String
  field_name  String
  field_value String
  // Deleting a referenced record (tiddler) will trigger the deletion of referencing record (field).
  tiddler     Tiddlers @relation(fields: [revision_id], references: [revision_id], onDelete: Cascade)

  @@id([revision_id, field_name])
  @@index([revision_id])
  @@map("fields")
}

model Groups {
  group_id    Int     @id @default(autoincrement())
  group_name  String  @unique()
  description String?
  roles       Roles[]
  users       Users[]

  @@map("groups")
}

model Roles {
  role_id     String   @id @default(uuid(7))
  role_name   String   @unique()
  description String?
  groups      Groups[]
  users       Users[]

  @@map("roles")
}

model Users {
  user_id    String     @id @default(uuid(7))
  username   String     @unique
  email      String     @unique
  password   String
  created_at DateTime   @default(now())
  last_login DateTime?
  sessions   Sessions[]
  groups     Groups[]
  roles      Roles[]

  @@map("users")
}

model Sessions {
  session_id    String   @id
  created_at    DateTime @default(now())
  last_accessed DateTime
  session_key   String?
  user_id       String
  user          Users    @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("sessions")
}
